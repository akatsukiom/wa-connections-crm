<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>WhatsApp Business Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    :root{
      --primary:#25D366;--primary-dark:#128C7E;--accent:#40c4ff;
      --bg:#0e171c;--bg-2:#172129;--card:#1f2b33;--muted:#8fa1ad;--muted-2:#6f838f;
      --ok:#28a745;--warn:#ffc107;--bad:#dc3545;--border:#2c3a43;--shadow:rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:
      linear-gradient(180deg,var(--bg) 0%,#0f1b22 100%);color:#e9edef}
    .container{max-width:1200px;margin:auto;padding:20px}
    header{background:linear-gradient(180deg,var(--card),var(--bg-2));border:1px solid var(--border);
      border-radius:18px;padding:22px 18px;box-shadow:0 12px 32px var(--shadow);margin-bottom:20px}
    .h-row{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));
      display:grid;place-items:center;box-shadow:0 8px 18px rgba(37,211,102,.3)}
    h1{margin:0;font-weight:700;font-size:22px;background:linear-gradient(90deg,var(--primary),var(--accent));
      -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .subtitle{font-size:12px;color:var(--muted)}
    .create{display:flex;gap:10px;align-items:center}
    input[type="text"]{background:var(--bg-2);border:1px solid var(--border);color:#e9edef;border-radius:12px;
      padding:10px 12px;min-width:240px;outline:none}
    input[type="text"]:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,211,102,.12)}
    button{border:1px solid transparent;background:linear-gradient(135deg,var(--primary),var(--primary-dark));
      color:#fff;border-radius:12px;padding:10px 14px;display:inline-flex;gap:8px;align-items:center;cursor:pointer;
      box-shadow:0 8px 18px rgba(37,211,102,.28);font-weight:600}
    button:disabled{opacity:.6;cursor:not-allowed}
    .btn-ghost{background:var(--bg-2);border:1px solid var(--border);box-shadow:none}
    .btn-bad{background:linear-gradient(135deg,#e64655,#b91d2a);box-shadow:0 8px 18px rgba(220,53,69,.25)}
    .btn-warn{background:linear-gradient(135deg,#ffc107,#f0a500);color:#222;box-shadow:0 8px 18px rgba(255,193,7,.25)}

    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:12px}
    .stat{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;display:flex;gap:12px;align-items:center}
    .stat .ico{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background:var(--bg-2)}
    .stat h3{margin:0;font-size:22px} .stat p{margin:2px 0 0;color:var(--muted);font-size:12px}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;position:relative;overflow:hidden}
    .card .top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
    .badge{font-size:12px;border-radius:999px;padding:4px 10px;display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border)}
    .b-ok{background:rgba(40,167,69,.16);color:#c5f7cf;border-color:#2a6e3b} 
    .b-warn{background:rgba(255,193,7,.18);color:#ffebad;border-color:#735e17}
    .b-bad{background:rgba(220,53,69,.18);color:#ffd1d6;border-color:#7c2830}
    .line{background:var(--bg-2);border:1px dashed var(--border);border-radius:14px;padding:10px 12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .qr{background:#fff;border-radius:14px;padding:16px;display:grid;place-items:center;min-height:140px;margin:10px 0}
    .qr img{max-width:100%;border-radius:8px}
    .row{display:flex;gap:10px;margin-top:6px}
    .row input{flex:1}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .logs{margin-top:8px;background:var(--bg-2);border:1px solid var(--border);border-radius:12px;padding:8px;height:90px;overflow:auto;font-size:12px;color:var(--muted-2)}
    .muted{color:var(--muted)} .copy{cursor:pointer;color:var(--accent)}
    .socket-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-left:8px;border:1px solid var(--border)}
    .ok{background:#2ecc71}.off{background:#e74c3c}.warn{background:#f1c40f}
    .toast{position:fixed;right:18px;bottom:18px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 14px;
      display:flex;gap:10px;min-width:280px;box-shadow:0 12px 28px var(--shadow);transform:translateY(18px);opacity:0;transition:all .25s}
    .toast.show{transform:translateY(0);opacity:1}
    .empty{margin-top:18px;background:var(--card);border:1px dashed var(--border);border-radius:16px;padding:28px;text-align:center;color:var(--muted)}
    @media (max-width:720px){.create{width:100%} .create input{flex:1}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="h-row">
        <div class="brand">
          <div class="logo"><i class="ri-whatsapp-fill"></i></div>
          <div>
            <h1>WhatsApp Business Hub</h1>
            <div class="subtitle">Conecta, monitorea y envía mensajes desde múltiples sesiones</div>
          </div>
        </div>
        <div class="create">
          <input id="sid" type="text" placeholder="ID de sesión (ej: soporte-1)" />
          <button id="btnCreate"><i class="ri-add-circle-line"></i>Crear sesión</button>
          <button id="btnRefresh" class="btn-ghost" title="Sincronizar listado"><i class="ri-refresh-line"></i></button>
          <span class="muted">Socket:<span id="sockDot" class="socket-dot off" title="socket"></span></span>
        </div>
      </div>
    </header>

    <section class="stats">
      <div class="stat"><div class="ico"><i class="ri-apps-2-line"></i></div><div><h3 id="totalSessions">0</h3><p>Sesiones totales</p></div></div>
      <div class="stat"><div class="ico"><i class="ri-check-double-line"></i></div><div><h3 id="readySessions">0</h3><p>Conectadas</p></div></div>
      <div class="stat"><div class="ico"><i class="ri-time-line"></i></div><div><h3 id="pendingSessions">0</h3><p>Pendientes</p></div></div>
      <div class="stat"><div class="ico"><i class="ri-message-3-line"></i></div><div><h3 id="totalMessages">0</h3><p>Mensajes hoy</p></div></div>
    </section>

    <section id="grid" class="grid"></section>
    <div id="empty" class="empty" style="display:none">
      <i class="ri-chat-3-line" style="font-size:48px;display:block;margin-bottom:8px"></i>
      Aún no hay sesiones. Crea la primera para comenzar.
    </div>
  </div>

  <div id="toast" class="toast"><i class="ri-information-line"></i><span></span></div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const sockDot = document.getElementById('sockDot');
    const sessions = new Map(); // id -> {el,imgWrap,status,log}
    let msgCount = 0;

    /* ---------- helpers UI ---------- */
    const toast = (t='Listo', type='info')=>{
      const el = document.getElementById('toast');
      el.querySelector('i').className =
        type==='ok' ? 'ri-check-line' : type==='bad' ? 'ri-error-warning-line' : 'ri-information-line';
      el.querySelector('span').textContent = t;
      el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'), 2200);
    };
    const updateStats = ()=>{
      const total = sessions.size;
      let ready=0, pending=0;
      sessions.forEach(s=>{
        if(s.status==='ready') ready++;
        else if(['qr','authenticating','initializing'].includes(s.status)) pending++;
      });
      qs('#totalSessions').textContent = total;
      qs('#readySessions').textContent = ready;
      qs('#pendingSessions').textContent = pending;
      qs('#totalMessages').textContent = msgCount;
      empty.style.display = total ? 'none' : 'block';
    };
    const statusClass = s=>{
      if(s==='ready') return 'b-ok';
      if(['qr','authenticating','initializing'].includes(s)) return 'b-warn';
      return 'b-bad';
    };
    const qs = sel => document.querySelector(sel);

    /* ---------- socket ---------- */
    const socket = io({ transports: ['websocket'] });
    socket.on('connect', ()=>{ sockDot.className='socket-dot ok'; });
    socket.on('disconnect', ()=>{ sockDot.className='socket-dot off'; });
    socket.on('connect_error', ()=>{ sockDot.className='socket-dot warn'; });

    /* ---------- render ---------- */
    function renderCard(s){
      const id = s.id;
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="top">
          <div style="display:flex;gap:10px;align-items:center">
            <i class="ri-smartphone-line"></i>
            <strong class="mono">${id}</strong>
          </div>
          <span class="badge ${statusClass(s.status)}"><span class="st">${s.status}</span></span>
        </div>

        <div class="line">
          <div><i class="ri-user-line"></i> <span class="muted">Número:</span>
            <span class="me mono">${s.me?.wid || '—'}</span>
            <a class="copy" title="Copiar WID"><i class="ri-file-copy-2-line"></i></a>
          </div>
          <button class="btn-ghost mini join"><i class="ri-notification-line"></i>Eventos</button>
        </div>

        <div class="qr"><div class="qrwrap">
          <div class="muted"><i class="ri-qr-code-line"></i> Esperando conexión…</div>
        </div></div>

        <div class="row">
          <input class="to" placeholder="Número (ej: 5215550000000)" />
        </div>
        <div class="row">
          <input class="msg" placeholder="Escribe tu mensaje…" />
          <button class="send"><i class="ri-send-plane-fill"></i>Enviar</button>
        </div>

        <div class="actions">
          <button class="btn-warn recon"><i class="ri-restart-line"></i>Reconectar</button>
          <button class="btn-bad del"><i class="ri-delete-bin-line"></i>Eliminar</button>
        </div>

        <div class="logs mono"></div>
      `;

      const state = { el, imgWrap: el.querySelector('.qrwrap'), status: s.status, log: el.querySelector('.logs') };
      sessions.set(id, state);
      grid.appendChild(el);

      // auto-join
      socket.emit('join', id);

      // actions
      el.querySelector('.copy').onclick = ()=>{
        const wid = el.querySelector('.me').textContent.trim();
        if(wid && wid !== '—'){ navigator.clipboard.writeText(wid); toast('WID copiado','ok'); }
      };
      el.querySelector('.send').onclick = async ()=>{
        const to = el.querySelector('.to').value.trim();
        const text = el.querySelector('.msg').value.trim();
        if(!to || !text) return toast('Número y mensaje requeridos','bad');
        el.querySelector('.send').disabled = true;
        try{
          const r = await fetch(`/api/sessions/${id}/messages`,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({to,text})
          }).then(r=>r.json());
          if(!r.ok) throw new Error(r.error||'error');
          msgCount++; el.querySelector('.msg').value='';
          addLog(id, `➡️ ${to}: ${text}`);
          toast('Mensaje enviado','ok'); updateStats();
        }catch(e){ toast('Error al enviar','bad'); }
        finally{ el.querySelector('.send').disabled = false; }
      };
      el.querySelector('.del').onclick = async ()=>{
        if(!confirm(`Eliminar sesión "${id}" y sus credenciales?`)) return;
        await fetch(`/api/sessions/${id}`,{method:'DELETE'});
        sessions.delete(id); el.remove(); toast('Sesión eliminada'); updateStats();
      };
      el.querySelector('.recon').onclick = async ()=>{
        // reconectar = eliminar + crear de nuevo
        await fetch(`/api/sessions/${id}`,{method:'DELETE'});
        await fetch('/api/sessions',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
        toast('Reconectando…'); // eventos llegarán por socket
      };
      el.querySelector('.join').onclick = ()=>{ socket.emit('join', id); toast(`Escuchando ${id}`) };

      updateStats();
    }

    /* ---------- QR / estado ---------- */
    function setStatus(id, status, me=null){
      const s = sessions.get(id); if(!s) return;
      s.status = status;
      s.el.querySelector('.badge').className = `badge ${statusClass(status)}`;
      s.el.querySelector('.st').textContent = status;
      if(me?.wid) s.el.querySelector('.me').textContent = me.wid;
      updateStats();
    }
    function setQR(id, dataUrl){
      const s = sessions.get(id); if(!s) return;
      if(dataUrl){
        s.imgWrap.innerHTML = `<img src="${dataUrl}" alt="QR">`;
      }else{
        s.imgWrap.innerHTML = `<div class="muted" style="color:#2ecc71"><i class="ri-check-double-line"></i> Conectado</div>`;
      }
    }
    function addLog(id, line){
      const s = sessions.get(id); if(!s) return;
      const time = new Date().toLocaleTimeString();
      s.log.textContent += `[${time}] ${line}\n`;
      s.log.scrollTop = s.log.scrollHeight;
    }

    /* ---------- socket events ---------- */
    socket.on('sessions', arr=>{
      grid.innerHTML=''; sessions.clear();
      arr.forEach(s=> renderCard(s));
    });

    socket.on('qr', ({id,qr})=>{
      if(!sessions.has(id)) renderCard({id,status:'qr'});
      setStatus(id,'qr'); setQR(id,qr); addLog(id,'QR generado');
    });
    socket.on('authenticated', ({id})=>{ setStatus(id,'authenticating'); addLog(id,'Autenticando…'); });
    socket.on('ready', ({id,me})=>{ setStatus(id,'ready',me); setQR(id,''); addLog(id,`Conectado ${me?.wid||''}`); });
    socket.on('auth_failure', ({id})=>{ setStatus(id,'auth_failure'); addLog(id,'Fallo de autenticación'); });
    socket.on('disconnected', ({id})=>{ setStatus(id,'disconnected'); addLog(id,'Desconectado'); });
    socket.on('message', ({id,message})=>{
      msgCount++; updateStats();
      addLog(id, `⬅️ ${message.from}: ${message.body.substring(0,120)}`);
    });

    /* ---------- crear sesión ---------- */
    document.getElementById('btnCreate').onclick = async ()=>{
      const id = document.getElementById('sid').value.trim();
      if(!id) return toast('Escribe un ID de sesión','bad');
      if(sessions.has(id)) return toast('Esa sesión ya existe','bad');
      const btn = document.getElementById('btnCreate'); btn.disabled = true;
      try{
        const r = await fetch('/api/sessions',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}).then(r=>r.json());
        renderCard({id,status:r.status||'initializing'}); socket.emit('join', id);
        document.getElementById('sid').value=''; toast('Sesión creada','ok');
      }catch(e){ toast('Error al crear','bad'); }
      finally{ btn.disabled=false; }
    };

    // Enter para crear
    document.getElementById('sid').addEventListener('keypress',e=>{ if(e.key==='Enter') qs('#btnCreate').click(); });

    // Sync manual
    document.getElementById('btnRefresh').onclick = ()=> fetch('/api/sessions').then(r=>r.json()).then(({data})=>{
      socket.emit('join','*'); // no hace nada en server, pero mantiene socket vivo
      grid.innerHTML=''; sessions.clear(); (data||[]).forEach(s=>renderCard(s));
      toast('Sincronizado','ok');
    });

    // Fallback: auto-sync cada 10s por si se perdió un evento
    setInterval(()=> {
      fetch('/api/sessions').then(r=>r.json()).then(({data})=>{
        const known = new Set();
        (data||[]).forEach(s=>{
          known.add(s.id);
          if(!sessions.has(s.id)) renderCard(s);
          setStatus(s.id, s.status, s.me||null);
          if(s.status==='ready') setQR(s.id,'');
        });
        // opcional: remover tarjetas inexistentes en server
        sessions.forEach((_,id)=>{ if(!known.has(id)){ const el=sessions.get(id).el; el.remove(); sessions.delete(id);} });
        updateStats();
      }).catch(()=>{});
    }, 10000);
  </script>
</body>
</html>
